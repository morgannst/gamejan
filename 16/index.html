<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏Å‡∏°‡∏ó‡∏≤‡∏¢‡∏®‡∏±‡∏û‡∏ó‡πå‡∏´‡∏£‡∏£‡∏©‡∏≤ - English Fun!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Itim&family=Mali:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Itim', 'Mali', cursive;
            background: linear-gradient(135deg, #fce4ec 0%, #f3e5f5 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        .chibi-bounce {
            animation: bounce 2s infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 4px solid #f8bbd0;
        }
        .star-rating {
            color: #ffca28;
            font-size: 3rem;
            text-shadow: 2px 2px #ff8f00;
        }
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }
        .btn-hover-pop:hover {
            transform: scale(1.05);
        }
        .btn-hover-pop:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-2xl mx-auto">
        <!-- Start Screen -->
        <div id="start-screen" class="glass-card rounded-3xl p-8 text-center shadow-2xl relative">
            <div class="flex justify-center mb-4">
                <svg width="120" height="120" viewBox="0 0 100 100" class="chibi-bounce">
                    <!-- Cute Chibi Girl SVG -->
                    <circle cx="50" cy="40" r="30" fill="#FFE0BD" />
                    <circle cx="50" cy="40" r="32" fill="none" stroke="#F06292" stroke-width="2" />
                    <path d="M20 40 Q20 10 50 10 Q80 10 80 40" fill="#4E342E" />
                    <circle cx="40" cy="40" r="3" fill="#000" />
                    <circle cx="60" cy="40" r="3" fill="#000" />
                    <path d="M45 50 Q50 55 55 50" fill="none" stroke="#F06292" stroke-width="2" stroke-linecap="round" />
                    <circle cx="35" cy="45" r="4" fill="#F8BBD0" opacity="0.6" />
                    <circle cx="65" cy="45" r="4" fill="#F8BBD0" opacity="0.6" />
                </svg>
            </div>
            <h1 class="text-4xl font-bold text-pink-600 mb-6">‡πÄ‡∏Å‡∏°‡∏ó‡∏≤‡∏¢‡∏®‡∏±‡∏û‡∏ó‡πå‡∏´‡∏£‡∏£‡∏©‡∏≤</h1>
            
            <div class="mb-6">
                <label class="block text-purple-600 text-lg mb-2">‡∏´‡∏ô‡∏π‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∞‡πÑ‡∏£‡∏à‡πä‡∏∞?</label>
                <input type="text" id="player-name" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢..." 
                    class="w-full p-4 rounded-2xl border-4 border-pink-200 focus:border-pink-400 outline-none text-center text-xl text-purple-700">
            </div>

            <button onclick="startGame()" class="bg-pink-500 hover:bg-pink-600 text-white font-bold py-4 px-10 rounded-full text-2xl shadow-lg btn-hover-pop transition mb-8">
                ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏•‡∏¢!
            </button>

            <div id="high-score-section" class="mt-4 text-left">
                <h3 class="text-xl font-bold text-purple-500 mb-3 border-b-2 border-dashed border-purple-200 pb-1">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ñ‡∏ô‡πÄ‡∏Å‡πà‡∏á (High Scores)</h3>
                <ul id="high-score-list" class="space-y-2 text-purple-700">
                    <!-- High scores injected here -->
                </ul>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="hidden glass-card rounded-3xl p-6 md:p-8 shadow-2xl relative">
            
            <!-- Home Button -->
            <button onclick="confirmGoHome()" class="absolute top-4 left-4 z-10 bg-white/80 hover:bg-white text-2xl p-2 rounded-full shadow-sm border-2 border-pink-100 transition btn-hover-pop" title="‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å">
                üè†
            </button>

            <!-- Progress Bar -->
            <div class="w-full bg-pink-100 rounded-full h-4 mb-6 mt-2 md:mt-0">
                <div id="progress" class="progress-bar bg-pink-500 h-4 rounded-full" style="width: 0%"></div>
            </div>

            <div class="flex justify-between items-center mb-4 pl-12"> <!-- Added padding-left for home button space -->
                <div class="text-xl font-bold text-purple-600">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <span id="current-score" class="text-pink-600">0</span></div>
                <button id="sound-toggle" onclick="toggleMusic()" class="text-3xl btn-hover-pop">üîä</button>
            </div>

            <div class="mb-6 relative">
                <div id="hint-image-container" class="w-full aspect-video rounded-2xl overflow-hidden bg-white border-4 border-pink-100 flex items-center justify-center relative">
                    <div id="loading-spinner" class="absolute inset-0 flex items-center justify-center bg-white z-10 hidden">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-pink-500"></div>
                    </div>
                    <img id="hint-image" src="" alt="‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ" class="w-full h-full object-cover">
                    <div id="hint-text-overlay" class="absolute bottom-4 left-4 bg-pink-500 text-white px-4 py-1 rounded-full text-lg shadow-md"></div>
                </div>
                
                <button onclick="useHint()" id="hint-btn" class="absolute -bottom-4 -right-2 bg-yellow-400 hover:bg-yellow-500 p-4 rounded-full shadow-lg border-4 border-white btn-hover-pop transition">
                    üí°
                </button>
            </div>

            <div class="text-center mb-6">
                <button onclick="speakCurrentWord()" class="bg-purple-100 hover:bg-purple-200 text-purple-600 px-6 py-2 rounded-full font-bold flex items-center mx-auto transition btn-hover-pop">
                    <span class="mr-2">üì¢</span> ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                </button>
            </div>

            <div id="input-area" class="space-y-4">
                <input type="text" id="answer-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©..." 
                    class="w-full p-4 rounded-2xl border-4 border-pink-200 focus:border-pink-400 outline-none text-center text-2xl text-purple-700 uppercase"
                    autocomplete="off">
                <button onclick="checkAnswer()" id="submit-btn" class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-4 rounded-2xl text-xl shadow-md transition btn-hover-pop">
                    ‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
                </button>
            </div>

            <!-- Feedback Modal -->
            <div id="feedback-overlay" class="hidden absolute inset-0 z-20 flex items-center justify-center bg-white/95 backdrop-blur-sm rounded-3xl p-4 text-center">
                <div id="feedback-content" class="w-full max-w-md">
                    <div id="feedback-emoji" class="text-7xl mb-4 animate-bounce"></div>
                    <div id="feedback-text" class="text-3xl font-bold mb-4"></div>
                    <div id="correct-answer-reveal" class="text-xl text-gray-600 mb-4"></div>
                    
                    <div class="bg-purple-50 p-4 rounded-2xl mb-6 border-2 border-purple-100">
                        <p id="example-sentence" class="text-xl font-bold text-purple-700 italic mb-2"></p>
                        <p id="example-translation" class="text-lg text-purple-500"></p>
                        <button onclick="speakExample()" class="mt-2 bg-purple-200 hover:bg-purple-300 text-purple-700 px-4 py-1 rounded-full text-sm font-bold transition">
                            üì¢ ‡∏ü‡∏±‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ
                        </button>
                    </div>

                    <button onclick="nextQuestion()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-2xl text-xl shadow-lg btn-hover-pop transition flex items-center justify-center gap-2">
                        ‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠‡πÑ‡∏õ ‚û°Ô∏è
                    </button>
                </div>
            </div>
        </div>

        <!-- Result Screen -->
        <div id="result-screen" class="hidden glass-card rounded-3xl p-8 text-center shadow-2xl relative">
            <!-- Home Button -->
            <button onclick="goHome()" class="absolute top-4 left-4 bg-white/80 hover:bg-white text-2xl p-2 rounded-full shadow-sm border-2 border-pink-100 transition btn-hover-pop" title="‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å">
                üè†
            </button>

            <h2 class="text-3xl font-bold text-purple-600 mb-4 mt-4">‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å‡∏à‡πâ‡∏≤! ‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡πâ‡∏ß</h2>
            
            <div id="star-container" class="star-rating mb-4">
                <!-- Stars will be injected here -->
            </div>

            <p id="praise-text" class="text-2xl font-bold text-pink-600 mb-6"></p>
            
            <div class="bg-pink-50 p-6 rounded-2xl mb-8">
                <p class="text-xl text-purple-600">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
                <p class="text-6xl font-bold text-pink-500"><span id="final-score">0</span>/10</p>
            </div>

            <div class="mb-8 text-left">
                <h3 class="text-xl font-bold text-purple-500 mb-3 border-b-2 border-dashed border-purple-200 pb-1 text-center">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</h3>
                <ul id="final-high-score-list" class="space-y-2 text-purple-700"></ul>
            </div>

            <button onclick="startGame()" class="bg-pink-500 hover:bg-pink-600 text-white font-bold py-4 px-10 rounded-full text-2xl shadow-lg btn-hover-pop transition">
                ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏∞!
            </button>
        </div>
    </div>

    <!-- Script Logic -->
    <script>
        // API Configuration
        const apiKey = "";
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'vocal-game-7yr';

        // Vocabulary Data Source (Master List)
        const vocabularySource = [
            { word: "library", translation: "‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏î", hintText: "‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏¢‡∏≠‡∏∞‡πÜ", example: "I read books at the library.", exampleTranslation: "‡∏â‡∏±‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏î" },
            { word: "cafe", translation: "‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà", hintText: "‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏ô‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°", example: "We like to visit the cute cafe.", exampleTranslation: "‡∏û‡∏ß‡∏Å‡πÄ‡∏£‡∏≤‡∏ä‡∏≠‡∏ö‡πÑ‡∏õ‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å" },
            { word: "museum", translation: "‡∏û‡∏¥‡∏û‡∏¥‡∏ò‡∏†‡∏±‡∏ì‡∏ë‡πå", hintText: "‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏Ç‡∏≠‡∏á‡∏´‡∏≤‡∏¢‡∏≤‡∏Å", example: "The museum has big dinosaurs.", exampleTranslation: "‡∏û‡∏¥‡∏û‡∏¥‡∏ò‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏°‡∏µ‡πÑ‡∏î‡πÇ‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏ç‡πà" },
            { word: "aquarium", translation: "‡∏û‡∏¥‡∏û‡∏¥‡∏ò‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ô‡πâ‡∏≥", hintText: "‡∏ó‡∏µ‡πà‡∏î‡∏π‡∏õ‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ô‡πâ‡∏≥", example: "The fish swim in the aquarium.", exampleTranslation: "‡∏õ‡∏•‡∏≤‡∏Å‡∏ß‡πà‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏û‡∏¥‡∏û‡∏¥‡∏ò‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ô‡πâ‡∏≥" },
            { word: "skate park", translation: "‡∏™‡∏ô‡∏≤‡∏°‡∏™‡πÄ‡∏Å‡πá‡∏ï", hintText: "‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô‡∏™‡πÄ‡∏Å‡πá‡∏ï‡∏ö‡∏≠‡∏£‡πå‡∏î", example: "Let's go to the skate park.", exampleTranslation: "‡πÑ‡∏õ‡∏™‡∏ô‡∏≤‡∏°‡∏™‡πÄ‡∏Å‡πá‡∏ï‡∏Å‡∏±‡∏ô‡πÄ‡∏ñ‡∏≠‡∏∞" },
            { word: "shopping centre", translation: "‡∏´‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", hintText: "‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏•‡πà‡∏ô", example: "I buy toys at the shopping centre.", exampleTranslation: "‡∏â‡∏±‡∏ô‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" },
            { word: "traffic", translation: "‡∏Å‡∏≤‡∏£‡∏à‡∏£‡∏≤‡∏à‡∏£", hintText: "‡∏£‡∏ñ‡∏ö‡∏ô‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏ô‡∏ô", example: "The traffic is moving slowly.", exampleTranslation: "‡∏£‡∏ñ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡πâ‡∏≤‡πÜ" },
            { word: "helicopter", translation: "‡πÄ‡∏Æ‡∏•‡∏¥‡∏Ñ‡∏≠‡∏õ‡πÄ‡∏ï‡∏≠‡∏£‡πå", hintText: "‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞‡∏ö‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏°‡∏µ‡πÉ‡∏ö‡∏û‡∏±‡∏î", example: "The helicopter flies in the sky.", exampleTranslation: "‡πÄ‡∏Æ‡∏•‡∏¥‡∏Ñ‡∏≠‡∏õ‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ö‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏ó‡πâ‡∏≠‡∏á‡∏ü‡πâ‡∏≤" },
            { word: "ferry", translation: "‡πÄ‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≤‡∏°‡∏ü‡∏≤‡∏Å", hintText: "‡πÄ‡∏£‡∏∑‡∏≠‡∏•‡∏≥‡πÉ‡∏´‡∏ç‡πà‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡πâ‡∏≥", example: "The ferry crosses the river.", exampleTranslation: "‡πÄ‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≤‡∏°‡∏ü‡∏≤‡∏Å‡πÅ‡∏•‡πà‡∏ô‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡πâ‡∏≥" },
            { word: "underground", translation: "‡∏£‡∏ñ‡πÑ‡∏ü‡πÉ‡∏ï‡πâ‡∏î‡∏¥‡∏ô", hintText: "‡∏£‡∏ñ‡πÑ‡∏ü‡∏ó‡∏µ‡πà‡∏ß‡∏¥‡πà‡∏á‡πÉ‡∏ï‡πâ‡∏î‡∏¥‡∏ô", example: "We take the underground to travel.", exampleTranslation: "‡∏û‡∏ß‡∏Å‡πÄ‡∏£‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏£‡∏ñ‡πÑ‡∏ü‡πÉ‡∏ï‡πâ‡∏î‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á" }
        ];

        // State variables
        let gameVocabulary = []; // Shuffled array for current game
        let currentIndex = 0;
        let score = 0;
        let playerName = "";
        let usedHintInThisTurn = false;
        let isMuted = false;
        let synth = window.speechSynthesis;

        // --- Initialization ---
        window.onload = () => {
            updateHighScoreDisplay();
            // Pre-warm the speech synth
            speakText("", "en-US"); 
        };

        function updateHighScoreDisplay() {
            const scores = JSON.parse(localStorage.getItem(`${appId}_scores`) || "[]");
            const top5 = scores.sort((a, b) => b.score - a.score).slice(0, 5);
            
            const listIds = ['high-score-list', 'final-high-score-list'];
            listIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.innerHTML = top5.length > 0 
                        ? top5.map((s, i) => `<li class="flex justify-between p-2 ${i === 0 ? 'bg-yellow-50 rounded-lg font-bold' : ''}">
                            <span>${i+1}. ${s.name}</span>
                            <span class="text-pink-500">${s.score} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>
                          </li>`).join('')
                        : '<li class="text-center text-gray-400 py-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡πâ‡∏≤ ‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å‡∏Å‡∏±‡∏ô!</li>';
                }
            });
        }

        // Fisher-Yates Shuffle Algorithm
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- Game Controls ---
        async function startGame() {
            // Check if player name exists if restarting from result screen, otherwise get from input
            const nameInput = document.getElementById('player-name').value.trim();
            if (!playerName && !nameInput) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏à‡πä‡∏∞!");
                return;
            }
            if (nameInput) playerName = nameInput;

            currentIndex = 0;
            score = 0;
            
            // Shuffle vocabulary for this session
            gameVocabulary = shuffleArray([...vocabularySource]);

            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('current-score').textContent = score;
            
            loadQuestion();
        }

        function confirmGoHome() {
            if (confirm("‡πÅ‡∏ô‡πà‡πÉ‡∏à‡πÑ‡∏´‡∏°‡∏à‡πä‡∏∞‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å? ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ô‡∏∞")) {
                goHome();
            }
        }

        function goHome() {
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('start-screen').classList.remove('hidden');
            
            // Reset simplified state
            document.getElementById('feedback-overlay').classList.add('hidden');
            document.getElementById('answer-input').value = "";
            playerName = ""; // Optional: Clear name to force re-entry or keep it
            document.getElementById('player-name').value = ""; 
        }

        async function loadQuestion() {
            if (currentIndex >= gameVocabulary.length) {
                endGame();
                return;
            }

            usedHintInThisTurn = false;
            const q = gameVocabulary[currentIndex];
            
            // UI reset
            document.getElementById('answer-input').value = "";
            document.getElementById('answer-input').disabled = false;
            document.getElementById('submit-btn').disabled = false;
            document.getElementById('feedback-overlay').classList.add('hidden');
            document.getElementById('hint-btn').classList.remove('opacity-50', 'cursor-not-allowed');
            document.getElementById('hint-text-overlay').textContent = q.hintText;
            
            // Progress Bar
            const progress = (currentIndex / gameVocabulary.length) * 100;
            document.getElementById('progress').style.width = `${progress}%`;

            // Audio: Auto-play pronunciation
            speakText(q.word, "en-US");

            // Image: Generate with Imagen
            await generateHintImage(q.word);
        }

        async function generateHintImage(word) {
            const imgEl = document.getElementById('hint-image');
            const spinner = document.getElementById('loading-spinner');
            
            spinner.classList.remove('hidden');
            imgEl.classList.add('opacity-0');

            const prompt = `Cute Chibi style educational illustration for a 7-year-old girl, representing the place "${word}". Soft pastel colors, pink and purple tones. High quality, no text, no letters, no alphabets in the image. Simple and friendly.`;
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        instances: [{ prompt: prompt }],
                        parameters: { sampleCount: 1 }
                    })
                });

                const result = await response.json();
                if (result.predictions && result.predictions[0]) {
                    imgEl.src = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                } else {
                    throw new Error("Failed to generate image");
                }
            } catch (err) {
                // Fallback placeholder if AI fails
                imgEl.src = `https://via.placeholder.com/600x400/fce4ec/ad1457?text=Image+for+${word}`;
            } finally {
                spinner.classList.add('hidden');
                imgEl.classList.remove('opacity-0');
            }
        }

        function checkAnswer() {
            const input = document.getElementById('answer-input').value.trim().toLowerCase();
            const correctWord = gameVocabulary[currentIndex].word.toLowerCase();
            const feedbackOverlay = document.getElementById('feedback-overlay');
            const feedbackEmoji = document.getElementById('feedback-emoji');
            const feedbackText = document.getElementById('feedback-text');
            const revealText = document.getElementById('correct-answer-reveal');
            const exSentence = document.getElementById('example-sentence');
            const exTranslation = document.getElementById('example-translation');

            const isCorrect = input === correctWord;
            
            if (isCorrect) {
                if (!usedHintInThisTurn) score++;
                feedbackEmoji.textContent = "‚≠ê";
                feedbackText.textContent = "‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î!";
                feedbackText.className = "text-3xl font-bold mb-4 text-green-500";
                revealText.textContent = `‡∏Ñ‡∏≥‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠: ${gameVocabulary[currentIndex].word}`;
                playSystemSound('correct');
            } else {
                if (score > 0) score--;
                feedbackEmoji.textContent = "üíñ";
                feedbackText.textContent = "‡πÄ‡∏™‡∏µ‡∏¢‡∏î‡∏≤‡∏¢‡∏à‡∏±‡∏á! ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞";
                feedbackText.className = "text-3xl font-bold mb-4 text-pink-500";
                revealText.textContent = `‡πÄ‡∏â‡∏•‡∏¢‡∏à‡πâ‡∏≤: ${gameVocabulary[currentIndex].word}`;
                playSystemSound('wrong');
            }

            document.getElementById('current-score').textContent = score;
            exSentence.textContent = gameVocabulary[currentIndex].example;
            exTranslation.textContent = `(${gameVocabulary[currentIndex].exampleTranslation})`;
            
            // Show feedback
            feedbackOverlay.classList.remove('hidden');
            speakText(gameVocabulary[currentIndex].example, "en-US");

            // REMOVED AUTO TIMEOUT. User must click "Next Question"
        }

        function nextQuestion() {
            currentIndex++;
            loadQuestion();
        }

        function useHint() {
            if (usedHintInThisTurn) return;
            usedHintInThisTurn = true;
            
            const inputEl = document.getElementById('answer-input');
            const firstLetter = gameVocabulary[currentIndex].word.charAt(0).toUpperCase();
            inputEl.value = firstLetter;
            inputEl.focus();
            
            document.getElementById('hint-btn').classList.add('opacity-50', 'cursor-not-allowed');
            
            // Feedback message for kids
            const msg = new SpeechSynthesisUtterance("‡∏Ñ‡∏≥‡∏ô‡∏µ‡πâ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß " + firstLetter);
            msg.lang = 'th-TH';
            synth.speak(msg);
        }

        function speakCurrentWord() {
            speakText(gameVocabulary[currentIndex].word, "en-US");
        }

        function speakExample() {
            speakText(gameVocabulary[currentIndex].example, "en-US");
        }

        function speakText(text, lang) {
            if (isMuted || !text) return;
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = lang;
            utter.rate = 0.8; // Slower for kids
            synth.speak(utter);
        }

        function playSystemSound(type) {
            if (isMuted) return;
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            if (type === 'correct') {
                oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime); // C5
                oscillator.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.5);
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            } else {
                oscillator.frequency.setValueAtTime(300, audioCtx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(150, audioCtx.currentTime + 0.5);
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            }

            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.5);
        }

        function toggleMusic() {
            isMuted = !isMuted;
            document.getElementById('sound-toggle').textContent = isMuted ? "üîá" : "üîä";
            if (isMuted) synth.cancel();
        }

        function endGame() {
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            
            document.getElementById('final-score').textContent = score;
            
            const starContainer = document.getElementById('star-container');
            const praiseText = document.getElementById('praise-text');
            
            let stars = "";
            if (score >= 8) {
                stars = "‚≠ê‚≠ê‚≠ê";
                praiseText.textContent = "‡∏ß‡πâ‡∏≤‡∏ß! ‡∏´‡∏ô‡∏π‡πÄ‡∏Å‡πà‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÄ‡∏•‡∏¢ ‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å‡∏à‡πâ‡∏≤!";
            } else if (score >= 5) {
                stars = "‚≠ê‚≠ê";
                praiseText.textContent = "‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å‡πÄ‡∏•‡∏¢‡∏à‡πä‡∏∞ ‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡πá‡∏à‡∏∞‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß!";
            } else {
                stars = "‚≠ê";
                praiseText.textContent = "‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏°‡∏≤‡∏Å‡∏à‡πä‡∏∞ ‡∏°‡∏≤‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô‡∏Å‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞!";
            }
            starContainer.textContent = stars;

            // Save high score
            saveScore(playerName, score);
            updateHighScoreDisplay();
        }

        function saveScore(name, score) {
            let scores = JSON.parse(localStorage.getItem(`${appId}_scores`) || "[]");
            scores.push({ name, score, date: new Date().toISOString() });
            scores.sort((a, b) => b.score - a.score);
            scores = scores.slice(0, 5); // Keep top 5
            localStorage.setItem(`${appId}_scores`, JSON.stringify(scores));
        }

        function resetGame() {
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('start-screen').classList.remove('hidden');
            document.getElementById('player-name').value = "";
        }
    </script>
</body>
</html>
