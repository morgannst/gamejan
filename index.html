<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡πÄ‡∏Å‡∏°‡∏ó‡∏≤‡∏¢‡∏®‡∏±‡∏û‡∏ó‡πå‡∏´‡∏£‡∏£‡∏©‡∏≤</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tone.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&family=Prompt:wght@300;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Prompt', sans-serif;
            background: linear-gradient(135deg, #fce7f3 0%, #e9d5ff 100%);
            overflow-x: hidden;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        .english-font { font-family: 'Nunito', sans-serif; }
        .card-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); }
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .pop-in { animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .game-input:focus {
            outline: none;
            border-color: #f472b6;
            box-shadow: 0 0 0 3px rgba(244, 114, 182, 0.3);
        }
        .star-pulse { animation: pulse-gold 2s infinite; }
        @keyframes pulse-gold {
            0% { transform: scale(1); filter: drop-shadow(0 0 0 rgba(250, 204, 21, 0.4)); }
            50% { transform: scale(1.1); filter: drop-shadow(0 0 10px rgba(250, 204, 21, 0.7)); }
            100% { transform: scale(1); filter: drop-shadow(0 0 0 rgba(250, 204, 21, 0.4)); }
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #f472b6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="app" class="w-full max-w-lg mx-auto relative">
        
        <!-- Music Toggle -->
        <button onclick="AudioEngine.toggleMusic()" class="fixed top-4 right-4 z-50 bg-white p-3 rounded-full shadow-lg text-pink-500 hover:text-pink-600 transition hover:scale-110 active:scale-95">
            <i id="music-icon" class="fas fa-volume-mute text-xl"></i>
        </button>

        <!-- Start Screen -->
        <div id="start-screen" class="bg-white rounded-3xl p-8 card-shadow text-center pop-in">
            <div class="mb-6">
                <i class="fas fa-star text-yellow-400 text-5xl mb-2 star-pulse"></i>
                <h1 class="text-3xl font-bold text-pink-500 mb-1">‡πÄ‡∏Å‡∏°‡∏ó‡∏≤‡∏¢‡∏®‡∏±‡∏û‡∏ó‡πå‡∏´‡∏£‡∏£‡∏©‡∏≤</h1>
                <p class="text-gray-400 text-sm">‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 25 Dec 2025</p>
            </div>

            <div class="mb-6">
                <label class="block text-gray-600 mb-2 font-medium">‡∏ô‡πâ‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏≠‡πà‡∏¢?</label>
                <input type="text" id="player-name" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏à‡πâ‡∏∞..." 
                    class="w-full px-4 py-3 rounded-xl border-2 border-pink-200 text-center text-lg text-pink-600 focus:border-pink-400 focus:outline-none transition-colors">
            </div>
            
            <div class="flex space-x-3 mb-4">
                <button onclick="AudioEngine.testSound()" class="flex-1 bg-yellow-100 hover:bg-yellow-200 text-yellow-600 font-bold py-2 px-4 rounded-xl text-sm transition active:scale-95">
                    <i class="fas fa-volume-up mr-1"></i> ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á
                </button>
            </div>

            <button onclick="startGame()" class="w-full bg-pink-400 hover:bg-pink-500 text-white font-bold py-3 px-6 rounded-2xl text-xl shadow-md transform transition hover:-translate-y-1 active:scale-95">
                <i class="fas fa-play mr-2"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÄ‡∏•‡∏¢!
            </button>

            <div class="mt-8 pt-6 border-t border-gray-100">
                <h3 class="text-pink-400 font-bold mb-3"><i class="fas fa-trophy text-yellow-400 mr-1"></i> ‡∏Ñ‡∏ô‡πÄ‡∏Å‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h3>
                <ul id="highscore-list-start" class="space-y-2 text-sm text-gray-600">
                    <li class="text-gray-400 italic">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</li>
                </ul>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="hidden bg-white rounded-3xl p-6 card-shadow relative min-h-[500px] flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <div class="bg-pink-100 px-3 py-1 rounded-full">
                    <span class="text-pink-500 font-bold text-sm">‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà <span id="q-current">1</span>/<span id="q-total">10</span></span>
                </div>
                <div class="bg-yellow-100 px-3 py-1 rounded-full flex items-center">
                    <i class="fas fa-star text-yellow-500 mr-1"></i>
                    <span id="score-display" class="text-yellow-600 font-bold">0</span>
                </div>
            </div>

            <div class="w-full bg-gray-100 rounded-full h-2.5 mb-8">
                <div id="progress-bar" class="bg-pink-400 h-2.5 rounded-full transition-all duration-500" style="width: 10%"></div>
            </div>

            <div id="question-area" class="flex-grow flex flex-col items-center">
                <div class="w-32 h-32 bg-purple-50 rounded-full flex items-center justify-center mb-4 border-4 border-purple-100 shadow-inner relative group cursor-pointer active:scale-95 transition touch-manipulation" onclick="playCurrentWord()">
                    <i id="vocab-icon" class="text-6xl text-purple-400"></i>
                    <div class="absolute bottom-0 right-0 bg-white p-2 rounded-full shadow-md text-pink-400">
                        <i class="fas fa-volume-up text-sm"></i>
                    </div>
                </div>

                <p id="thai-hint" class="text-gray-500 mb-6 font-medium text-lg text-center"></p>

                <div class="w-full relative mb-4">
                    <input type="text" id="answer-input" autocomplete="off" 
                        class="game-input english-font w-full text-center text-3xl font-bold py-3 text-gray-700 border-b-4 border-gray-200 bg-transparent placeholder-gray-300"
                        placeholder="Type answer...">
                    <button onclick="useHint()" id="hint-btn" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-yellow-400 hover:text-yellow-500 transition p-2 touch-manipulation" title="‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ">
                        <i class="fas fa-lightbulb text-2xl"></i>
                    </button>
                </div>

                <div id="feedback-msg" class="h-6 text-center font-bold mb-4"></div>

                <button onclick="checkAnswer()" id="submit-btn" class="w-full bg-purple-400 hover:bg-purple-500 text-white font-bold py-3 rounded-xl shadow-md transition transform active:scale-95 touch-manipulation">
                    ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
                </button>
            </div>

            <!-- Result Overlay -->
            <div id="result-overlay" class="hidden absolute inset-0 bg-white/95 rounded-3xl z-10 flex flex-col items-center justify-center p-6 text-center backdrop-blur-sm">
                <div id="result-icon-container" class="mb-4 text-6xl"></div>
                <h2 id="result-title" class="text-2xl font-bold mb-2"></h2>
                
                <div class="bg-pink-50 p-4 rounded-xl w-full mb-6 border border-pink-100">
                    <p id="example-en" class="english-font text-xl text-pink-600 font-bold mb-1"></p>
                    <p id="example-th" class="text-gray-500 text-sm"></p>
                    <button onclick="playCurrentSentence()" class="mt-2 text-pink-400 hover:text-pink-600 text-sm p-2">
                        <i class="fas fa-volume-up"></i> ‡∏ü‡∏±‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ
                    </button>
                </div>

                <div class="flex space-x-3 w-full">
                    <button onclick="resetGame()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-600 font-bold py-3 rounded-xl transition active:scale-95">
                        <i class="fas fa-home"></i> ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
                    </button>
                    <button id="next-q-btn" onclick="nextQuestion()" class="flex-1 bg-purple-400 hover:bg-purple-500 text-white font-bold py-3 rounded-xl shadow-md transition transform active:scale-95">
                        ‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- End Screen -->
        <div id="end-screen" class="hidden bg-white rounded-3xl p-8 card-shadow text-center">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏à‡πâ‡∏≤!</h2>
            
            <div id="final-stars" class="flex justify-center space-x-2 text-4xl mb-4 text-gray-200">
                <i class="fas fa-star" id="star-1"></i>
                <i class="fas fa-star" id="star-2"></i>
                <i class="fas fa-star" id="star-3"></i>
            </div>

            <p id="final-praise" class="text-xl font-bold text-pink-500 mb-2">‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡πÑ‡∏õ‡πÄ‡∏•‡∏¢!</p>
            <p class="text-gray-500 mb-6">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: <span id="final-score" class="text-2xl text-purple-600 font-bold"></span>/10</p>

            <div class="grid grid-cols-2 gap-3 mb-6">
                <div class="bg-blue-50 p-3 rounded-xl">
                    <p class="text-xs text-gray-500">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥</p>
                    <p id="final-accuracy" class="text-lg font-bold text-blue-500">0%</p>
                </div>
                <div class="bg-green-50 p-3 rounded-xl">
                    <p class="text-xs text-gray-500">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß (WPM)</p>
                    <p id="final-wpm" class="text-lg font-bold text-green-500">0</p>
                </div>
            </div>

            <div id="sync-status" class="mb-4 text-sm text-gray-400 flex items-center justify-center h-6"></div>

            <div class="bg-gray-50 rounded-xl p-4 mb-6">
                <h3 class="text-sm font-bold text-gray-400 mb-2 text-left">üèÜ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å</h3>
                <ul id="highscore-list-end" class="space-y-2 text-sm text-gray-600 text-left"></ul>
            </div>

            <button onclick="resetGame()" class="w-full bg-pink-400 hover:bg-pink-500 text-white font-bold py-3 px-6 rounded-2xl text-xl shadow-md transition transform hover:-translate-y-1 active:scale-95">
                <i class="fas fa-redo mr-2"></i> ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
            </button>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è ‡∏ß‡∏≤‡∏á URL ‡∏Ç‡∏≠‡∏á Google Apps Script ‡∏ó‡∏µ‡πà Deploy ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzfQYOxqFcn8tZbzYTQCbRXzP6qbpju6TMl6WjpGPcW4oCOeXm8hR_MWxVJbvUKwaOl7Q/exec';

        // --- DATA ---
        const vocabulary = [
            { word: "homes", thaiHint: "‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏∑‡∏≠‡∏ô ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢‡πÅ‡∏ö‡∏ö‡∏ï‡πà‡∏≤‡∏á‡πÜ", icon: "fa-house-chimney", sentence: "People live in different homes.", thai: "‡∏ú‡∏π‡πâ‡∏Ñ‡∏ô‡∏≠‡∏≤‡∏®‡∏±‡∏¢‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô" },
            { word: "cave house", thaiHint: "‡∏ö‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ñ‡πâ‡∏≥", icon: "fa-dungeon", sentence: "Some people live in a cave house.", thai: "‡∏ö‡∏≤‡∏á‡∏Ñ‡∏ô‡∏≠‡∏≤‡∏®‡∏±‡∏¢‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡∏ñ‡πâ‡∏≥" },
            { word: "adobe house", thaiHint: "‡∏ö‡πâ‡∏≤‡∏ô‡∏î‡∏¥‡∏ô ‡∏ó‡∏≥‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡∏•‡∏ô", icon: "fa-square", sentence: "An adobe house is made of mud.", thai: "‡∏ö‡πâ‡∏≤‡∏ô‡∏î‡∏¥‡∏ô‡∏ó‡∏≥‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡∏•‡∏ô" },
            { word: "stilt house", thaiHint: "‡∏ö‡πâ‡∏≤‡∏ô‡∏¢‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏™‡∏π‡∏á ‡∏´‡∏ô‡∏µ‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°", icon: "fa-water", sentence: "A stilt house stands on long legs.", thai: "‡∏ö‡πâ‡∏≤‡∏ô‡∏¢‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏™‡∏π‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡πÄ‡∏™‡∏≤‡∏™‡∏π‡∏á‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡πâ‡∏≥" },
            { word: "skyscraper", thaiHint: "‡∏ï‡∏∂‡∏Å‡∏™‡∏π‡∏á‡∏£‡∏∞‡∏ü‡πâ‡∏≤ ‡πÉ‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÉ‡∏´‡∏ç‡πà", icon: "fa-building", sentence: "The skyscraper is very tall.", thai: "‡∏ï‡∏∂‡∏Å‡∏£‡∏∞‡∏ü‡πâ‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å" },
            { word: "kitchen", thaiHint: "‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£", icon: "fa-utensils", sentence: "Mom cooks food in the kitchen.", thai: "‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏°‡πà‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ß" },
            { word: "bedroom", thaiHint: "‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏ö‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô", icon: "fa-bed", sentence: "I sleep in my bedroom.", thai: "‡∏â‡∏±‡∏ô‡∏ô‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏ö‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô" },
            { word: "bathroom", thaiHint: "‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥", icon: "fa-bath", sentence: "I wash my hands in the bathroom.", thai: "‡∏â‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏°‡∏∑‡∏≠‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥" },
            { word: "playground", thaiHint: "‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏î‡πá‡∏Å‡πÄ‡∏•‡πà‡∏ô", icon: "fa-child-reaching", sentence: "We play at the playground.", thai: "‡∏û‡∏ß‡∏Å‡πÄ‡∏£‡∏≤‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏î‡πá‡∏Å‡πÄ‡∏•‡πà‡∏ô" },
            { word: "see-saw", thaiHint: "‡∏°‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡∏î‡∏Å ‡∏Ç‡∏∂‡πâ‡∏ô‡πÜ ‡∏•‡∏á‡πÜ", icon: "fa-scale-balanced", sentence: "The see-saw goes up and down.", thai: "‡∏°‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡∏î‡∏Å‡∏Ç‡∏¢‡∏±‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏•‡∏á" }
        ];

        // --- GAME STATE ---
        const GameState = {
            currentQIndex: 0,
            score: 0,
            playerName: "",
            usedHint: false,
            startTime: null,
            totalCorrectChars: 0,
            vocabList: [] // Stores shuffled vocabulary
        };

        // --- UTILS ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- AUDIO ENGINE ---
        const AudioEngine = {
            synths: {},
            bgMusic: null,
            isMusicPlaying: false,
            cachedVoice: null,
            initialized: false,

            init() {
                if (this.initialized) return;
                this.synths.correct = new Tone.PolySynth(Tone.Synth).toDestination();
                this.synths.correct.volume.value = -5;
                this.synths.wrong = new Tone.MembraneSynth().toDestination();
                this.synths.click = new Tone.Synth({
                    oscillator: { type: "triangle" },
                    envelope: { attack: 0.01, decay: 0.1, sustain: 0, release: 0.1 }
                }).toDestination();
                this.synths.click.volume.value = -10;

                this.initMusic();
                
                window.utterances = [];
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.onvoiceschanged = () => this.loadVoices();
                    this.loadVoices();
                }

                const unlockHandler = () => {
                    this.unlock();
                    document.body.removeEventListener('touchstart', unlockHandler);
                    document.body.removeEventListener('click', unlockHandler);
                };
                document.body.addEventListener('touchstart', unlockHandler);
                document.body.addEventListener('click', unlockHandler);
                
                this.initialized = true;
            },

            initMusic() {
                const synth = new Tone.PolySynth(Tone.Synth, {
                    oscillator: { type: "sine" },
                    envelope: { attack: 0.1, release: 1 }
                }).toDestination();
                synth.volume.value = -20;
                
                const melody = [
                    {"time": "0:0", "note": ["C4", "E4"]}, {"time": "0:2", "note": ["E4", "G4"]},
                    {"time": "1:0", "note": ["D4", "F4"]}, {"time": "1:2", "note": ["F4", "A4"]},
                ];
                
                this.bgMusic = new Tone.Part((time, value) => {
                    synth.triggerAttackRelease(value.note, "8n", time);
                }, melody);
                this.bgMusic.loop = true;
                this.bgMusic.loopEnd = "2m";
            },

            async unlock() {
                if (Tone.context.state !== 'running') await Tone.start();
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const empty = new SpeechSynthesisUtterance('');
                    empty.volume = 0;
                    window.speechSynthesis.speak(empty);
                }
            },

            async toggleMusic() {
                if (!this.initialized) this.init();
                await this.unlock();
                const icon = document.getElementById('music-icon');
                if (this.isMusicPlaying) {
                    Tone.Transport.stop();
                    icon.className = "fas fa-volume-mute text-xl";
                    this.isMusicPlaying = false;
                } else {
                    Tone.Transport.start();
                    icon.className = "fas fa-music text-xl";
                    this.isMusicPlaying = true;
                }
            },

            playSound(type) {
                if (Tone.context.state !== 'running') Tone.start();
                const now = Tone.now();
                try {
                    switch (type) {
                        case 'correct': this.synths.correct.triggerAttackRelease(["C5", "E5", "G5", "C6"], "8n", now); break;
                        case 'wrong': this.synths.wrong.triggerAttackRelease("A2", "4n", now); this.synths.wrong.triggerAttackRelease("G2", "4n", now + 0.3); break;
                        case 'click': this.synths.click.triggerAttackRelease("C5", "32n", now); break;
                        case 'fanfare': this.synths.correct.triggerAttackRelease(["C4", "E4", "G4", "C5", "E5", "G5"], "4n", now); break;
                    }
                } catch(e) { console.log('Audio error:', e); }
            },

            loadVoices() {
                if (!('speechSynthesis' in window)) return;
                const voices = window.speechSynthesis.getVoices();
                this.cachedVoice = voices.find(v => v.lang === 'en-US') || 
                                   voices.find(v => v.lang.startsWith('en')) || 
                                   voices[0];
            },

            speak(text) {
                if (!('speechSynthesis' in window)) return;
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.9;
                utterance.pitch = 1.1;
                utterance.volume = 1.0;
                if (this.cachedVoice) {
                    utterance.voice = this.cachedVoice;
                    utterance.lang = this.cachedVoice.lang;
                } else {
                    this.loadVoices();
                    if (this.cachedVoice) {
                        utterance.voice = this.cachedVoice;
                        utterance.lang = this.cachedVoice.lang;
                    }
                }
                window.utterances.push(utterance);
                utterance.onend = () => {
                    window.utterances = window.utterances.filter(u => u !== utterance);
                };
                window.speechSynthesis.speak(utterance);
            },

            testSound() {
                this.unlock();
                this.playSound('click');
                this.speak('Hello!');
            }
        };

        // --- GAME LOGIC ---

        function init() {
            AudioEngine.init();
            loadHighScores('highscore-list-start');
        }

        async function startGame() {
            const nameInput = document.getElementById('player-name');
            const inputName = nameInput.value.trim();
            if (!inputName) {
                nameInput.classList.add('shake');
                setTimeout(() => nameInput.classList.remove('shake'), 500);
                return;
            }
            await AudioEngine.unlock();
            AudioEngine.playSound('click');
            if (!AudioEngine.isMusicPlaying) AudioEngine.toggleMusic();

            GameState.playerName = inputName;
            GameState.score = 0;
            GameState.currentQIndex = 0;
            GameState.totalCorrectChars = 0;
            GameState.startTime = new Date();
            GameState.vocabList = shuffleArray([...vocabulary]);

            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('end-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            setTimeout(loadQuestion, 50); 
        }

        function loadQuestion() {
            const data = GameState.vocabList[GameState.currentQIndex];
            GameState.usedHint = false;

            document.getElementById('q-current').innerText = GameState.currentQIndex + 1;
            document.getElementById('q-total').innerText = GameState.vocabList.length;
            document.getElementById('score-display').innerText = GameState.score;
            document.getElementById('progress-bar').style.width = `${((GameState.currentQIndex) / GameState.vocabList.length) * 100}%`;
            
            const iconEl = document.getElementById('vocab-icon');
            iconEl.className = `fas ${data.icon} text-6xl text-purple-400`;
            iconEl.style.transform = "none";
            document.getElementById('thai-hint').innerText = data.thaiHint;
            
            const input = document.getElementById('answer-input');
            input.value = "";
            input.disabled = false;
            input.focus();

            const hintBtn = document.getElementById('hint-btn');
            hintBtn.disabled = false;
            hintBtn.classList.remove('text-gray-300');
            hintBtn.classList.add('text-yellow-400');
            
            document.getElementById('submit-btn').style.display = 'block';
            document.getElementById('result-overlay').classList.add('hidden');
            document.getElementById('feedback-msg').innerText = "";
            AudioEngine.speak(data.word);
        }

        function playCurrentWord() {
            AudioEngine.speak(GameState.vocabList[GameState.currentQIndex].word);
        }

        function playCurrentSentence() {
            AudioEngine.speak(GameState.vocabList[GameState.currentQIndex].sentence);
        }

        function useHint() {
            if (GameState.usedHint) return;
            GameState.usedHint = true;
            AudioEngine.playSound('click');
            const word = GameState.vocabList[GameState.currentQIndex].word;
            document.getElementById('answer-input').value = word.charAt(0);
            document.getElementById('answer-input').focus();
            
            document.getElementById('hint-btn').disabled = true;
            document.getElementById('hint-btn').classList.remove('text-yellow-400');
            document.getElementById('hint-btn').classList.add('text-gray-300');
            
            const feedback = document.getElementById('feedback-msg');
            feedback.innerText = "‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ‡πÅ‡∏•‡πâ‡∏ß (‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ô‡∏∞‡∏à‡πä‡∏∞)";
            feedback.className = "h-6 text-center font-bold mb-4 text-yellow-500 text-sm";
        }

        function checkAnswer() {
            const input = document.getElementById('answer-input').value.trim().toLowerCase();
            const target = GameState.vocabList[GameState.currentQIndex].word.toLowerCase();
            const data = GameState.vocabList[GameState.currentQIndex];

            if (!input) return;

            const isCorrect = input === target;
            let resultInfo = {};

            if (isCorrect) {
                AudioEngine.playSound('correct');
                resultInfo = { title: "‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å!", icon: '<i class="fas fa-check-circle text-green-400"></i>', cls: "text-green-500" };
                GameState.totalCorrectChars += target.length;
                if (!GameState.usedHint) GameState.score++;
            } else {
                AudioEngine.playSound('wrong');
                resultInfo = { title: `‡∏ú‡∏¥‡∏î‡∏à‡πâ‡∏≤! ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏∑‡∏≠: ${target}`, icon: '<i class="fas fa-times-circle text-red-400"></i>', cls: "text-red-500" };
                if (GameState.score > 0) GameState.score--;
            }

            document.getElementById('score-display').innerText = GameState.score;
            document.getElementById('submit-btn').style.display = 'none';
            const overlay = document.getElementById('result-overlay');
            overlay.classList.remove('hidden');
            
            document.getElementById('result-icon-container').innerHTML = resultInfo.icon;
            document.getElementById('result-title').innerText = resultInfo.title;
            document.getElementById('result-title').className = `text-2xl font-bold mb-2 ${resultInfo.cls}`;
            document.getElementById('example-en').innerText = data.sentence;
            document.getElementById('example-th').innerText = data.thai;

            const nextBtn = document.getElementById('next-q-btn');
            const isLast = GameState.currentQIndex === GameState.vocabList.length - 1;
            nextBtn.innerHTML = isLast ? '‡∏î‡∏π‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô <i class="fas fa-flag-checkered"></i>' : '‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ <i class="fas fa-arrow-right"></i>';
            AudioEngine.speak(data.sentence);
        }

        function nextQuestion() {
            GameState.currentQIndex++;
            if (GameState.currentQIndex < GameState.vocabList.length) {
                loadQuestion();
            } else {
                endGame();
            }
        }

        function endGame() {
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('end-screen').classList.remove('hidden');
            
            let stars = 1;
            let praise = "‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î‡∏ô‡∏∞!";
            if (GameState.score >= 8) { stars = 3; praise = "‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î! ‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞‡∏ï‡∏±‡∏ß‡∏à‡∏¥‡πã‡∏ß!"; }
            else if (GameState.score >= 5) { stars = 2; praise = "‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å! ‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏î‡∏µ‡πÄ‡∏•‡∏¢"; }

            const durationMinutes = (new Date() - GameState.startTime) / 60000;
            const wpm = durationMinutes > 0 ? Math.round((GameState.totalCorrectChars / 5) / durationMinutes) : 0;
            const accuracy = Math.round((GameState.score / GameState.vocabList.length) * 100);

            document.getElementById('final-wpm').innerText = wpm;
            document.getElementById('final-accuracy').innerText = accuracy + "%";
            document.getElementById('final-praise').innerText = praise;
            document.getElementById('final-score').innerText = GameState.score;

            for(let i=1; i<=3; i++) {
                document.getElementById(`star-${i}`).className = stars >= i ? "fas fa-star text-yellow-400 pop-in" : "fas fa-star text-gray-200";
            }

            if (stars === 3) setTimeout(() => AudioEngine.playSound('fanfare'), 200);

            saveHighScore(GameState.playerName, GameState.score);
            loadHighScores('highscore-list-end');
            sendToGoogleSheet(GameState.playerName, GameState.score, wpm, accuracy);
        }

        function sendToGoogleSheet(name, score, wpm, accuracy) {
            const statusDiv = document.getElementById('sync-status');
            statusDiv.innerHTML = '<div class="loader mr-2"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô...';
            
            const data = { name, score, wpm, accuracy };

            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'text/plain;charset=utf-8',
                },
                body: JSON.stringify(data)
            })
            .then(() => {
                statusDiv.innerHTML = '<span class="text-green-500"><i class="fas fa-check-circle"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</span>';
            })
            .catch(err => {
                console.error(err);
                statusDiv.innerHTML = '<span class="text-red-400"><i class="fas fa-times-circle"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>';
            });
        }

        function resetGame() {
            document.getElementById('end-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('result-overlay').classList.add('hidden');
            document.getElementById('start-screen').classList.remove('hidden');
            document.getElementById('player-name').value = "";
            document.getElementById('sync-status').innerHTML = "";
            loadHighScores('highscore-list-start');
        }

        function saveHighScore(name, score) {
            let highScores = JSON.parse(localStorage.getItem('vocabGameScores')) || [];
            const date = new Date().toLocaleString('th-TH', { 
                day: 'numeric', month: 'short', year: '2-digit',
                hour: '2-digit', minute: '2-digit'
            });
            highScores.push({ name, score, date });
            highScores.sort((a, b) => b.score - a.score);
            highScores = highScores.slice(0, 5);
            localStorage.setItem('vocabGameScores', JSON.stringify(highScores));
        }

        function loadHighScores(elementId) {
            const list = document.getElementById(elementId);
            const highScores = JSON.parse(localStorage.getItem('vocabGameScores')) || [];
            list.innerHTML = "";
            if (highScores.length === 0) {
                list.innerHTML = '<li class="text-gray-400 italic">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</li>';
                return;
            }
            highScores.forEach((entry, index) => {
                const li = document.createElement('li');
                li.className = "flex justify-between items-center bg-gray-50 px-3 py-2 rounded-lg";
                let badge = index === 0 ? '<i class="fas fa-crown text-yellow-500 ml-2"></i>' : '';
                
                li.innerHTML = `
                    <div class="flex flex-col">
                        <span class="font-medium text-pink-600">${index + 1}. ${entry.name}${badge}</span>
                        <span class="text-[10px] text-gray-400">${entry.date || '-'}</span>
                    </div>
                    <span class="font-bold text-gray-600">${entry.score} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>
                `;
                list.appendChild(li);
            });
        }

        document.getElementById('answer-input').addEventListener("keypress", function(event) {
            if (event.key === "Enter") { event.preventDefault(); checkAnswer(); }
        });

        window.onload = init;
    </script>
</body>
</html>
